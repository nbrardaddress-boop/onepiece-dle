<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>OnePieceDLE ‚Äî Classic</title>
  <style>
    body{font-family:system-ui;margin:24px;max-width:900px}
    input,button{padding:10px;font-size:16px}
    .card{border:1px solid #ddd;border-radius:10px;padding:12px;margin:10px 0}
    .pills{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .pill{font-size:12px;padding:6px 8px;border-radius:999px;color:#fff}
    .g{background:#16a34a}.r{background:#dc2626}.y{background:#eab308;color:#111}
    .opts button{display:block;width:100%;text-align:left;margin-top:6px}
    #msg{margin-top:10px}
  </style>
</head>
<body>

<h1>üè¥‚Äç‚ò†Ô∏è OnePieceDLE ‚Äî Classic</h1>
<p id="date"></p>

<form id="form">
  <input id="q" placeholder="Tape un personnage‚Ä¶" autocomplete="off">
  <button>OK</button>
</form>

<div class="opts" id="opts"></div>
<p id="msg"></p>

<h2>Essais</h2>
<div id="guesses"></div>

<script>
/* utils */
const normalize=s=>(s||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9 ]/g," ").replace(/\s+/g," ").trim();
const pad=n=>n<10?"0"+n:n;
const today=()=>{const d=new Date();return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;}
function hash(s){let h=2166136261;for(let i=0;i<s.length;i++){h^=s.charCodeAt(i);h=Math.imul(h,16777619)}return h>>>0;}

const dk=today();
document.getElementById("date").textContent="Date : "+dk;
const storageKey="classic:"+dk;

let characters=[], target=null;
let guesses=JSON.parse(localStorage.getItem(storageKey)||"[]");

/* rendu */
function pill(c,l,v){return `<span class="pill ${c}">${l}: ${v}</span>`;}
function render(){
  document.getElementById("guesses").innerHTML =
    guesses.map(g=>`
      <div class="card">
        <strong>${g.name}</strong>
        <div class="pills">${g.results.join("")}</div>
      </div>`).join("") || "<p>Aucun essai.</p>";
}
render();

/* LOAD JSON ‚Äî CHEMIN CORRECT POUR REPO PROJET */
async function init(){
  const msg=document.getElementById("msg");
  try{
    const url = location.origin + location.pathname.replace(/\/$/, "") + "/characters.json";
    const res = await fetch(url);
    if(!res.ok) throw new Error("HTTP "+res.status);
    characters = await res.json();
    target = characters[hash("classic:"+dk)%characters.length];
    msg.textContent="‚úÖ Base charg√©e ("+characters.length+" personnages)";
  }catch(e){
    msg.textContent="‚ùå Erreur data : "+e.message;
  }
}
init();

/* autocomplete */
const q=document.getElementById("q");
const opts=document.getElementById("opts");

q.addEventListener("input",()=>{
  const v=normalize(q.value);
  if(!v){opts.innerHTML="";return;}
  opts.innerHTML=characters
    .filter(c=>normalize(c.name).includes(v))
    .slice(0,8)
    .map(c=>`<button type="button" data-id="${c.id}">${c.name}</button>`)
    .join("");
});

opts.addEventListener("click",e=>{
  const b=e.target.closest("button"); if(!b) return;
  submit(characters.find(c=>c.id===b.dataset.id));
});

/* submit */
document.getElementById("form").addEventListener("submit",e=>{
  e.preventDefault();
  submit(characters.find(c=>normalize(c.name)===normalize(q.value)));
});

function submit(c){
  const msg=document.getElementById("msg");
  if(!c||!target){msg.textContent="Erreur perso";return;}
  if(guesses.some(g=>g.id===c.id)){msg.textContent="D√©j√† tent√©";return;}

  const r=[];
  r.push(pill(c.gender===target.gender?"g":"r","gender",c.gender));
  r.push(pill(c.role_main===target.role_main?"g":"r","role",c.role_main));
  r.push(pill(c.affiliation===target.affiliation?"g":"r","crew",c.affiliation));

  guesses.unshift({id:c.id,name:c.name,results:r});
  localStorage.setItem(storageKey,JSON.stringify(guesses));
  render();
  q.value=""; opts.innerHTML="";
}
</script>

</body>
</html>
