<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OnePieceDLE ‚Äî Classic</title>

  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      margin: 24px;
      max-width: 900px;
    }
    h1 { margin-bottom: 4px; }
    input, button {
      padding: 10px;
      font-size: 16px;
    }
    button { cursor: pointer; }
    .card {
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 12px;
      margin: 10px 0;
    }
    .pills {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    .pill {
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      color: #fff;
      white-space: nowrap;
    }
    .g { background: #16a34a; }
    .r { background: #dc2626; }
    .y { background: #eab308; color: #111; }

    .opts button {
      display: block;
      width: 100%;
      text-align: left;
      margin-top: 6px;
      border: 1px solid #eee;
      border-radius: 10px;
      background: #fafafa;
    }

    #msg { color: #dc2626; margin-top: 8px; }
  </style>
</head>

<body>
  <h1>üè¥‚Äç‚ò†Ô∏è OnePieceDLE ‚Äî Classic</h1>
  <p id="date"></p>

  <form id="form">
    <input id="q" placeholder="Tape un personnage‚Ä¶" autocomplete="off" />
    <button type="submit">OK</button>
  </form>

  <div class="opts" id="opts"></div>
  <p id="msg"></p>

  <h2>Essais</h2>
  <div id="guesses"></div>

<script>
/* ---------- Utils ---------- */
const pad2 = n => n < 10 ? "0" + n : n;
const dateKey = () => {
  const d = new Date();
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
};
const normalize = s =>
  (s || "")
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/[^a-z0-9 ]/g, " ")
    .replace(/\s+/g, " ")
    .trim();

function hash(str) {
  let h = 2166136261;
  for (let i = 0; i < str.length; i++) {
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return h >>> 0;
}
function pickDaily(list, key) {
  return list[hash("classic:" + key) % list.length];
}

/* ---------- Comparisons ---------- */
function pill(cls, label, value) {
  return `<span class="pill ${cls}">${label}: ${value}</span>`;
}
function compText(label, g, t) {
  const v = g || "‚Äî";
  return pill(g && t && g === t ? "g" : "r", label, v);
}
function compBool(label, g, t) {
  const gv = g === true ? "Yes" : "No";
  const tv = t === true ? "Yes" : "No";
  return pill(gv === tv ? "g" : "r", label, gv);
}
function compAge(g, t) {
  if (typeof g !== "number" || typeof t !== "number") {
    return pill("r", "age", g ?? "?");
  }
  if (g === t) return pill("g", "age", g);
  return pill("y", "age", `${g} ${g < t ? "‚Üë" : "‚Üì"}`);
}

/* ---------- State ---------- */
const dk = dateKey();
document.getElementById("date").textContent = "Date : " + dk;
const storageKey = "classic:" + dk;

let characters = [];
let target = null;
let guesses = JSON.parse(localStorage.getItem(storageKey) || "[]");

/* ---------- Render ---------- */
function renderGuesses() {
  const box = document.getElementById("guesses");
  if (guesses.length === 0) {
    box.innerHTML = "<p>Aucun essai.</p>";
    return;
  }
  box.innerHTML = guesses.map(g => `
    <div class="card">
      <strong>${g.name}</strong>
      <div class="pills">${g.results.join("")}</div>
    </div>
  `).join("");
}
renderGuesses();

/* ---------- Load data (CORRIG√â) ---------- */
async function init() {
  try {
    const url = new URL("characters.json", window.location.href);
    const res = await fetch(url.toString());
    if (!res.ok) throw new Error("HTTP " + res.status);
    characters = await res.json();
    if (!Array.isArray(characters) || characters.length === 0) {
      throw new Error("JSON vide ou invalide");
    }
    target = pickDaily(characters, dk);
  } catch (e) {
    document.getElementById("msg").textContent =
      "Erreur data : " + e.message;
  }
}
init();

/* ---------- Autocomplete ---------- */
const q = document.getElementById("q");
const opts = document.getElementById("opts");

q.addEventListener("input", () => {
  const v = normalize(q.value);
  if (!v) { opts.innerHTML = ""; return; }
  const list = characters
    .filter(c => normalize(c.name + " " + (c.name_alt || "")).includes(v))
    .slice(0, 8);
  opts.innerHTML = list.map(c =>
    `<button type="button" data-id="${c.id}">${c.name}</button>`
  ).join("");
});

opts.addEventListener("click", e => {
  const b = e.target.closest("button");
  if (!b) return;
  submit(characters.find(c => c.id === b.dataset.id));
});

/* ---------- Submit ---------- */
document.getElementById("form").addEventListener("submit", e => {
  e.preventDefault();
  const v = normalize(q.value);
  const c = characters.find(x => normalize(x.name) === v);
  submit(c);
});

function submit(c) {
  document.getElementById("msg").textContent = "";
  if (!c || !target) return;

  if (guesses.some(g => g.id === c.id)) {
    document.getElementById("msg").textContent = "D√©j√† tent√©.";
    return;
  }

  const results = [
    compText("gender", c.gender, target.gender),
    compAge(c.age, target.age),
    compText("role", c.role_main, target.role_main),
    compText("status", c.status, target.status),
    compText("affiliation", c.affiliation, target.affiliation),
    compBool("fruit", c.devil_fruit_has, target.devil_fruit_has),
    compText("fruit_type", c.devil_fruit_type, target.devil_fruit_type),
    compText("haki", c.haki, target.haki),
    compText("sea", c.sea_origin, target.sea_origin),
    compText("first_arc", c.first_arc, target.first_arc),
  ];

  guesses.unshift({ id: c.id, name: c.name, results });
  localStorage.setItem(storageKey, JSON.stringify(guesses));
  renderGuesses();

  q.value = "";
  opts.innerHTML = "";
}
</script>
</body>
</html>
